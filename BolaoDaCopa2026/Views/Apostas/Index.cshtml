@model IEnumerable<BolaoDaCopa2026.Models.Jogo>
@using BolaoDaCopa2026.Models
@{
    var apostas = ViewBag.Apostas as List<Aposta>;
    var pontuacaoService = new PontuacaoService();
}

<header>
    <h1>Meus Palpites</h1>
</header>

<div class="container">

    @foreach (var jogo in Model)
    {
        var aposta = apostas?.FirstOrDefault(a => a.JogoId == jogo.Id);

        int pontos = 0;
        string classePontos = "pontos-neutro";

        if (!jogo.EstaAberto && aposta != null)
        {
            pontos = pontuacaoService.CalcularPontuacaoApostador(
            jogo.GolsSelecaoA ?? 0,
            jogo.GolsSelecaoB ?? 0,
            aposta.GolsSelecaoA,
            aposta.GolsSelecaoB
            );

            // Define cores para visual feedback
            if (pontos == 10) classePontos = "pontos-exato";       // Placar exato
            else if (pontos == 7 || pontos == 5) classePontos = "pontos-parcial"; // Resultado certo
            else if (pontos == 2) classePontos = "pontos-minimo";  // Acerto parcial
        }

        <div class="fase">
            <h2>@jogo.Fase</h2>

            <div class="jogo @(jogo.EstaAberto ? "aberto" : "encerrado")">

                <div class="times">
                    <div class="time">
                        <img src="@jogo.SelecaoA.BandeiraUrl" />
                        @jogo.SelecaoA.Nome
                    </div>

                    <span class="vs">vs</span>

                    <div class="time">
                        <img src="@jogo.SelecaoB.BandeiraUrl" />
                        @jogo.SelecaoB.Nome
                    </div>
                </div>

                <div class="info">
                    @jogo.DataHora.ToString("dd/MM HH:mm")
                </div>

                <div class="acao">
                    @if (jogo.EstaAberto)
                    {
                        <form asp-action="Salvar" method="post" class="palpite">
                            <input type="hidden" name="jogoId" value="@jogo.Id" />

                            <div class="placar">
                                <input type="number"
                                       name="golsSelecaoA"
                                       min="0"
                                       value="@aposta?.GolsSelecaoA" />

                                <span class="x">x</span>

                                <input type="number"
                                       name="golsSelecaoB"
                                       min="0"
                                       value="@aposta?.GolsSelecaoB" />
                            </div>

                            <button class="btn btn-salvar">
                                @(aposta == null ? "Salvar" : "Atualizar")
                            </button>
                        </form>
                    }
                    else
                    {
                        <div class="placar">
                            <strong>@aposta?.GolsSelecaoA</strong>
                            <span class="x">x</span>
                            <strong>@aposta?.GolsSelecaoB</strong>
                            @if (aposta != null)
                            {
                                <span class="pontos @classePontos">(@pontos pts)</span>
                            }
                        </div>
                    }
                </div>

            </div>
        </div>
    }

</div>

<style>
    .placar {
        font-size: 1.2rem;
        margin-top: 0.5rem;
    }

    .x {
        margin: 0 0.5rem;
        font-weight: bold;
    }

    .pontos {
        margin-left: 1rem;
        font-weight: bold;
    }

    .pontos-exato {
        color: green;
    }

    .pontos-parcial {
        color: orange;
    }

    .pontos-minimo {
        color: #555;
    }

    .pontos-neutro {
        color: #999;
    }

    .palpite input {
        width: 50px;
        text-align: center;
    }

    .btn-salvar {
        margin-left: 10px;
    }
</style>
