@model List<BolaoDaCopa2026.Models.Jogo>

@{
    ViewData["Title"] = "Home";
    var agora = DateTime.Now;

    var proximoJogo = Model?
        .Where(j => j.DataHora > agora)
        .OrderBy(j => j.DataHora)
        .FirstOrDefault();
}

<section class="landing">
    <div class="landing_card">

        <h1>Bolão da Copa 2026</h1>

        @if (Model != null && Model.Any())
        {
            <div class="games-wrapper">
                @{
                    bool countdownUsado = false;
                }

                @foreach (var jogo in Model)
                {
                    var emAndamento =
                    jogo.DataHora <= agora &&
                    jogo.Status == "EmAndamento";

                    <div class="game-card">
                        <div class="game-meta @(emAndamento ? "live" : "upcoming")">
                            <span class="status-text">
                                @(emAndamento
                                                        ? "Jogo em andamento"
                                                        : jogo.Status == "Finalizado"
                                                        ? "Jogo finalizado"
                                                        : "Próximo jogo")
                    </span>

                            <span class="divider">•</span>

                            <span class="datetime">
                                @jogo.DataHora.ToString("dd/MM • HH:mm")
                            </span>
                        </div>

                        <h2>@jogo.Fase</h2>

                        <div class="matchup">
                            <div class="team side-a">
                                <img src="@jogo.SelecaoA.BandeiraUrl"
                                     alt="@jogo.SelecaoA.Nome" />
                                <span class="team-name">@jogo.SelecaoA.Nome</span>
                            </div>

                            <div class="vs-badge">×</div>

                            <div class="team side-b">
                                <img src="@jogo.SelecaoB.BandeiraUrl"
                                     alt="@jogo.SelecaoB.Nome" />
                                <span class="team-name">@jogo.SelecaoB.Nome</span>
                            </div>
                        </div>

                @if (jogo.Status == "Finalizado")
                        {
                            <div class="resultado-final">
                                <strong>
                                    @jogo.GolsSelecaoA
                                    ×
                                    @jogo.GolsSelecaoB
                                </strong>
                            </div>
                        }
                        else if (!emAndamento && !countdownUsado)
                        {
                            countdownUsado = true;

                            <div class="countdown"
                                 data-date="@jogo.DataHora.ToString("yyyy-MM-ddTHH:mm:ss")">
                                <div class="time-box">
                                    <div class="time-value days">00</div>
                                    <div class="time-label">Dias</div>
                                </div>
                                <div class="time-box">
                                    <div class="time-value hours">00</div>
                                    <div class="time-label">Horas</div>
                                </div>
                                <div class="time-box">
                                    <div class="time-value minutes">00</div>
                                    <div class="time-label">Min</div>
                                </div>
                                <div class="time-box">
                                    <div class="time-value seconds">00</div>
                                    <div class="time-label">Seg</div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </div>
        }
        else
        {
            <p class="text-muted">
                Nenhum jogo agendado.
                O caos ainda está em preparação.
            </p>
        }

        <div class="actions">
            @using Microsoft.AspNetCore.Http

            @if (Context.Session.GetInt32("ApostadorId") == null)
            {
                <a class="btn btn_primario"
                   asp-controller="Conta"
                   asp-action="Login">
                    Entrar no Bolão
                </a>
            }

            @if (Context.Session.GetString("IsAdmin")?.Equals("True", StringComparison.OrdinalIgnoreCase) == true)
            {
                <a class="btn btn-outline-primary" asp-controller="AdminJogos"
                   asp-action="Index"
                   class="btn btn-admin">
                    Painel de Administração
                </a>
            }


            <a href="/Apostas" class="btn btn_secundario">
                Minhas Apostas
            </a>

            <a href="/Selecoes" class="btn btn_secundario">
                Tabela da Copa
            </a>
        </div>
    </div>

    @if (proximoJogo != null)
    {
        <script>
            function updateCountdowns() {
                document.querySelectorAll(".countdown").forEach(countdown => {
                    const targetDate = new Date(countdown.dataset.date).getTime();
                    const now = Date.now();
                    const diff = targetDate - now;

                    const daysEl = countdown.querySelector(".days");
                    const hoursEl = countdown.querySelector(".hours");
                    const minutesEl = countdown.querySelector(".minutes");
                    const secondsEl = countdown.querySelector(".seconds");

                    if (!daysEl || !hoursEl || !minutesEl || !secondsEl) return;

                    if (diff <= 0) {
                        daysEl.textContent =
                        hoursEl.textContent =
                        minutesEl.textContent =
                        secondsEl.textContent = "00";
                        return;
                    }

                    daysEl.textContent = String(Math.floor(diff / (1000 * 60 * 60 * 24))).padStart(2, "0");
                    hoursEl.textContent = String(Math.floor((diff / (1000 * 60 * 60)) % 24)).padStart(2, "0");
                    minutesEl.textContent = String(Math.floor((diff / (1000 * 60)) % 60)).padStart(2, "0");
                    secondsEl.textContent = String(Math.floor((diff / 1000) % 60)).padStart(2, "0");
                });
            }

            updateCountdowns();
            setInterval(updateCountdowns, 1000);
        </script>
    }
</section>
